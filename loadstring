local UserInputService = game:GetService("UserInputService")
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer
local camera = workspace.CurrentCamera
local mouse = player:GetMouse()

-- Aimbot settings
local settings = {
    enabled = false,
    key = Enum.KeyCode.E,
    teamCheck = true,  -- Won't target teammates
    maxDistance = 1000, -- Maximum distance to detect players
    sensitivity = 0.5, -- Lower value = smoother camera movement
}

-- Create GUI
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "AimbotGUI"
ScreenGui.Parent = player.PlayerGui

local Frame = Instance.new("Frame")
Frame.Size = UDim2.new(0, 200, 0, 150)
Frame.Position = UDim2.new(0.85, 0, 0.4, 0)
Frame.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
Frame.BorderSizePixel = 0
Frame.Parent = ScreenGui

local TitleBar = Instance.new("Frame")
TitleBar.Size = UDim2.new(1, 0, 0, 30)
TitleBar.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
TitleBar.BorderSizePixel = 0
TitleBar.Parent = Frame

local Title = Instance.new("TextLabel")
Title.Size = UDim2.new(1, 0, 1, 0)
Title.BackgroundTransparency = 1
Title.Text = "Aimbot Settings"
Title.TextColor3 = Color3.fromRGB(255, 255, 255)
Title.TextSize = 16
Title.Font = Enum.Font.SourceSansBold
Title.Parent = TitleBar

local Content = Instance.new("Frame")
Content.Size = UDim2.new(1, 0, 1, -30)
Content.Position = UDim2.new(0, 0, 0, 30)
Content.BackgroundTransparency = 1
Content.Parent = Frame

-- Enabled Toggle
local EnabledLabel = Instance.new("TextLabel")
EnabledLabel.Size = UDim2.new(0.6, 0, 0, 30)
EnabledLabel.Position = UDim2.new(0.05, 0, 0, 10)
EnabledLabel.BackgroundTransparency = 1
EnabledLabel.Text = "Enabled:"
EnabledLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
EnabledLabel.TextSize = 14
EnabledLabel.TextXAlignment = Enum.TextXAlignment.Left
EnabledLabel.Font = Enum.Font.SourceSans
EnabledLabel.Parent = Content

local EnabledButton = Instance.new("TextButton")
EnabledButton.Size = UDim2.new(0.25, 0, 0, 20)
EnabledButton.Position = UDim2.new(0.7, 0, 0, 15)
EnabledButton.BackgroundColor3 = Color3.fromRGB(255, 50, 50)
EnabledButton.Text = "OFF"
EnabledButton.TextColor3 = Color3.fromRGB(255, 255, 255)
EnabledButton.TextSize = 14
EnabledButton.Font = Enum.Font.SourceSansBold
EnabledButton.Parent = Content

-- Team Check Toggle
local TeamCheckLabel = Instance.new("TextLabel")
TeamCheckLabel.Size = UDim2.new(0.6, 0, 0, 30)
TeamCheckLabel.Position = UDim2.new(0.05, 0, 0, 50)
TeamCheckLabel.BackgroundTransparency = 1
TeamCheckLabel.Text = "Team Check:"
TeamCheckLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
TeamCheckLabel.TextSize = 14
TeamCheckLabel.TextXAlignment = Enum.TextXAlignment.Left
TeamCheckLabel.Font = Enum.Font.SourceSans
TeamCheckLabel.Parent = Content

local TeamCheckButton = Instance.new("TextButton")
TeamCheckButton.Size = UDim2.new(0.25, 0, 0, 20)
TeamCheckButton.Position = UDim2.new(0.7, 0, 0, 55)
TeamCheckButton.BackgroundColor3 = Color3.fromRGB(50, 255, 50)
TeamCheckButton.Text = "ON"
TeamCheckButton.TextColor3 = Color3.fromRGB(255, 255, 255)
TeamCheckButton.TextSize = 14
TeamCheckButton.Font = Enum.Font.SourceSansBold
TeamCheckButton.Parent = Content

-- Status Label
local StatusLabel = Instance.new("TextLabel")
StatusLabel.Size = UDim2.new(0.9, 0, 0, 20)
StatusLabel.Position = UDim2.new(0.05, 0, 0, 90)
StatusLabel.BackgroundTransparency = 1
StatusLabel.Text = "Press E to toggle aimbot"
StatusLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
StatusLabel.TextSize = 14
StatusLabel.TextXAlignment = Enum.TextXAlignment.Center
StatusLabel.Font = Enum.Font.SourceSans
StatusLabel.Parent = Content

-- GUI button functionality
EnabledButton.MouseButton1Click:Connect(function()
    settings.enabled = not settings.enabled
    if settings.enabled then
        EnabledButton.BackgroundColor3 = Color3.fromRGB(50, 255, 50)
        EnabledButton.Text = "ON"
        StatusLabel.Text = "Aimbot Active - Press E to lock"
    else
        EnabledButton.BackgroundColor3 = Color3.fromRGB(255, 50, 50)
        EnabledButton.Text = "OFF"
        StatusLabel.Text = "Press E to toggle aimbot"
    end
end)

TeamCheckButton.MouseButton1Click:Connect(function()
    settings.teamCheck = not settings.teamCheck
    if settings.teamCheck then
        TeamCheckButton.BackgroundColor3 = Color3.fromRGB(50, 255, 50)
        TeamCheckButton.Text = "ON"
    else
        TeamCheckButton.BackgroundColor3 = Color3.fromRGB(255, 50, 50)
        TeamCheckButton.Text = "OFF"
    end
end)

-- Function to check if a player is valid to target
local function isValidTarget(targetPlayer)
    if targetPlayer == player then return false end
    if targetPlayer.Character == nil then return false end
    if not targetPlayer.Character:FindFirstChild("Head") then return false end
    if not targetPlayer.Character:FindFirstChild("Humanoid") then return false end
    if targetPlayer.Character.Humanoid.Health <= 0 then return false end
    
    -- Team check
    if settings.teamCheck and targetPlayer.Team == player.Team then return false end
    
    -- Check for obstacles (basic raycast)
    local ray = Ray.new(camera.CFrame.Position, (targetPlayer.Character.Head.Position - camera.CFrame.Position).Unit * settings.maxDistance)
    local hit, position = workspace:FindPartOnRay(ray, player.Character, false, true)
    
    if hit and hit:IsDescendantOf(targetPlayer.Character) then
        return true
    elseif not hit then
        return true
    end
    
    return false
end

-- Function to get closest player
local function getClosestPlayer()
    local closestPlayer = nil
    local shortestDistance = settings.maxDistance

    for _, p in pairs(Players:GetPlayers()) do
        if isValidTarget(p) then
            local distance = (p.Character.Head.Position - player.Character.Head.Position).Magnitude
            if distance < shortestDistance then
                closestPlayer = p
                shortestDistance = distance
            end
        end
    end
    
    return closestPlayer
end

-- Target locking variables
local targetPlayer = nil
local isAiming = false

-- Input handling
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    
    if input.KeyCode == settings.key and settings.enabled then
        isAiming = not isAiming
        
        if isAiming then
            targetPlayer = getClosestPlayer()
            if targetPlayer then
                StatusLabel.Text = "Locked on: " .. targetPlayer.Name
            else
                StatusLabel.Text = "No valid target found"
                isAiming = false
            end
        else
            StatusLabel.Text = "Aimbot Active - Press E to lock"
            targetPlayer = nil
        end
    end
end)

-- Aiming logic
RunService.RenderStepped:Connect(function()
    if isAiming and targetPlayer and settings.enabled then
        if isValidTarget(targetPlayer) then
            local targetPosition = targetPlayer.Character.Head.Position
            
            -- Smoothly move camera towards target
            local targetCFrame = CFrame.new(camera.CFrame.Position, targetPosition)
            camera.CFrame = camera.CFrame:Lerp(targetCFrame, settings.sensitivity)
        else
            -- Target no longer valid
            isAiming = false
            targetPlayer = nil
            StatusLabel.Text = "Target lost"
        end
    end
end)

-- Make GUI draggable
local dragging = false
local dragInput
local dragStart
local startPos

local function updateDrag(input)
    local delta = input.Position - dragStart
    Frame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
end

TitleBar.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true
        dragStart = input.Position
        startPos = Frame.Position
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                dragging = false
            end
        end)
    end
end)

TitleBar.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement then
        dragInput = input
    end
end)

UserInputService.InputChanged:Connect(function(input)
    if input == dragInput and dragging then
        updateDrag(input)
    end
end)
